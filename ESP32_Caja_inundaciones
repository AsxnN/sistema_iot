#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "time.h"

// ========== CONFIGURACIÓN WiFi ==========
const char* ssid = "Task";
const char* password = "2demayo1265";

// ========== CONFIGURACIÓN SERVIDOR LARAVEL ==========
// const char* serverURL = "http://10.246.166.15:8000/api/sensores";
const char* serverURL = "http://10.59.12.15:8000/api/sensores";

// ========== CONFIGURACIÓN GOOGLE SHEETS ==========
const char* googleScriptURL = "https://script.google.com/macros/s/AKfycbyb8bdx2yZOUvugppMI7gL2R2Fe4Rq5mvn7vHcvhF09049tPszy0aasuuoxf0dfh-ZK/exec";

// ========== ID ÚNICO DEL DISPOSITIVO ==========
const char* DISPOSITIVO_ID = "nodo_ribera_norte_01";
const char* ZONA = "Ribera Norte";

// ========== PINES SERIAL ESP32-S3 ==========
#define RXD2 44
#define TXD2 43

// ========== LED INDICADOR ==========
#define LED_BUILTIN 2

unsigned long lastReconnect = 0;
unsigned long lastDataReceived = 0;
unsigned long previousMillisTDS = 0;
unsigned long previousMillisDHT11 = 0;

unsigned long tiempoAnteriorHora = 0;
const unsigned long intervaloHora = 60000; // 60 segundos

const unsigned long intervaloEnvio = 2 * 60 * 60 * 1000UL; // 2 horas ms

int totalEnviados = 0;
int totalErrores = 0;
int totalGoogleSheets = 0;

int ultimoNivelEnviado = -1;  // Último nivel enviado

// IP y puerto de la caja de alertas (ajusta a tu red)
const char* alertBoxIP = "10.59.12.153";
const int alertBoxPort = 80;

void setup() {
  Serial.begin(115200);
  Serial1.begin(9600, SERIAL_8N1, RXD2, TXD2);

  pinMode(LED_BUILTIN, OUTPUT);
  digitalWrite(LED_BUILTIN, LOW);

  Serial.println("\n\nESP32 Sistema IoT");

  Serial.print("Conectando a WiFi ");
  Serial.println(ssid);

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  int intentos = 0;
  while (WiFi.status() != WL_CONNECTED && intentos < 30) {
    delay(500);
    Serial.print(".");
    intentos++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi conectado");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
    digitalWrite(LED_BUILTIN, HIGH);
  } else {
    Serial.println("\nError: No conectado a WiFi");
  }

  configTime(-5 * 3600, 0, "pool.ntp.org");
  struct tm timeinfo;
  int retries = 0;
  while (!getLocalTime(&timeinfo) && retries < 20) {
    delay(500);
    retries++;
  }
  if (retries == 20) Serial.println("Error sincronizando hora NTP");
  else Serial.println("Hora sincronizada correctamente");
}

void loop() {
  unsigned long tiempoActual = millis();

  if (WiFi.status() != WL_CONNECTED) {
    if (tiempoActual - lastReconnect > 10000) {
      Serial.println("WiFi desconectado, reconectando...");
      WiFi.reconnect();
      lastReconnect = tiempoActual;
    }
    digitalWrite(LED_BUILTIN, LOW);
    delay(100);
    return;
  } else {
    digitalWrite(LED_BUILTIN, HIGH);
  }

  // Enviar hora al Arduino cada 60 segundos
  if (tiempoActual - tiempoAnteriorHora > intervaloHora) {
    enviarHoraArduino();
    tiempoAnteriorHora = tiempoActual;
  }

  if (Serial1.available()) {
    String jsonArduino = Serial1.readStringUntil('\n');
    jsonArduino.trim();

    if (jsonArduino.length() < 5) return;

    lastDataReceived = tiempoActual;

    StaticJsonDocument<512> docArduino;
    DeserializationError error = deserializeJson(docArduino, jsonArduino);

    if (error) {
      Serial.print("Error parseando JSON: ");
      Serial.println(error.c_str());
      totalErrores++;
      return;
    }

    if (!docArduino.containsKey("nivel") || !docArduino.containsKey("temperatura") || !docArduino.containsKey("tds")) {
      Serial.println("JSON incompleto");
      totalErrores++;
      return;
    }

    int nivel = docArduino["nivel"];
    String estadoNivel = docArduino["estado_nivel"] | "Sin datos";
    float temperatura = docArduino["temperatura"];
    String estadoTemp = docArduino["estado_temp"] | "Sin datos";
    float humedad = docArduino["humedad"];
    int tds = docArduino["tds"];
    String estadoTds = docArduino["estado_tds"] | "Sin datos";

    if (tiempoActual - previousMillisTDS >= intervaloEnvio) {
      enviarGoogleSheets("TDS", tds, estadoTds);
      enviarGoogleSheets("DHT11", temperatura, humedad, estadoTemp);
      previousMillisTDS = tiempoActual;
    }

    if (nivel != ultimoNivelEnviado) {
      enviarGoogleSheets("NIVEL_AGUA", nivel, estadoNivel);
      ultimoNivelEnviado = nivel;
    }

    // Enviar alerta a caja de alertas si nivel 1 (desbordamiento)
    if (nivel == 1) {
      enviarAlertaCaja(alertBoxIP, alertBoxPort);
    }

    StaticJsonDocument<1024> docEnvio;
    docEnvio["dispositivo_id"] = DISPOSITIVO_ID;
    docEnvio["nivel"] = nivel;
    docEnvio["estado_nivel"] = estadoNivel;
    docEnvio["temperatura"] = temperatura;
    docEnvio["estado_temp"] = estadoTemp;
    docEnvio["humedad"] = humedad;
    docEnvio["tds"] = tds;
    docEnvio["estado_tds"] = estadoTds;
    docEnvio["timestamp"] = tiempoActual;
    docEnvio["rssi"] = WiFi.RSSI();
    docEnvio["ip"] = WiFi.localIP().toString();

    String jsonString;
    serializeJson(docEnvio, jsonString);
    Serial.println(jsonString);

    enviarDatos(jsonString);
  }

  if (lastDataReceived > 0 && (tiempoActual - lastDataReceived > 30000)) {
    Serial.println("No se reciben datos de Arduino desde hace 30 seg");
    lastDataReceived = tiempoActual;
  }

  delay(50);
}

void enviarHoraArduino() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    Serial.println("No se pudo obtener la hora NTP");
    return;
  }
  char buffer[9];
  strftime(buffer, sizeof(buffer), "%H:%M:%S", &timeinfo);
  Serial1.print("HORA:");
  Serial1.println(buffer);
  Serial.print("Hora enviada al Arduino: ");
  Serial.println(buffer);
}

void enviarDatos(String jsonData) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Sin conexión WiFi");
    totalErrores++;
    return;
  }

  HTTPClient http;
  http.setTimeout(5000);

  http.begin(serverURL);
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Accept", "application/json");

  int httpCode = http.POST(jsonData);

  if (httpCode > 0) {
    Serial.print("Código HTTP: ");
    Serial.println(httpCode);

    if (httpCode == HTTP_CODE_OK || httpCode == HTTP_CODE_CREATED) {
      String payload = http.getString();
      Serial.println("Respuesta del servidor:");
      Serial.println(payload);

      totalEnviados++;
    } else {
      Serial.print("Error HTTP inesperado: ");
      Serial.println(httpCode);
      totalErrores++;
    }
  } else {
    Serial.print("Error HTTP Post: ");
    Serial.println(http.errorToString(httpCode).c_str());
    totalErrores++;
  }

  http.end();
}

void enviarGoogleSheets(String hoja, int valor, String estado) {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = String(googleScriptURL) + "?hoja=" + hoja;

  if (hoja == "TDS") {
    url += "&tds=" + String(valor);
    url += "&calidad=" + urlencode(estado);
  } else if (hoja == "NIVEL_AGUA") {
    url += "&sensor_bajo=" + String(valor);
    url += "&nivel_clasificacion=" + urlencode(estado);
  }

  http.begin(url);
  http.setTimeout(10000);
  int httpCode = http.GET();

  if (httpCode == 200) {
    totalGoogleSheets++;
    Serial.print("Google Sheets (");
    Serial.print(hoja);
    Serial.println(") OK");
  } else {
    Serial.print("Error Google Sheets (");
    Serial.print(hoja);
    Serial.print("): ");
    Serial.println(httpCode);
  }

  http.end();
}

void enviarGoogleSheets(String hoja, float temp, float hum, String estado) {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = String(googleScriptURL) + "?hoja=" + hoja;
  url += "&temperatura=" + String(temp);
  url += "&humedad=" + String(hum);
  url += "&estado=" + urlencode(estado);

  http.begin(url);
  http.setTimeout(10000);
  int httpCode = http.GET();

  if (httpCode == 200) {
    totalGoogleSheets++;
    Serial.print("Google Sheets (");
    Serial.print(hoja);
    Serial.println(") OK");
  } else {
    Serial.print("Error Google Sheets (");
    Serial.print(hoja);
    Serial.print("): ");
    Serial.println(httpCode);
  }

  http.end();
}

void enviarAlertaCaja(const char* ip, int port) {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = String("http://") + ip + ":" + String(port) + "/alerta";

  http.begin(url);
  int code = http.GET();
  if (code == 200) {
    Serial.println("Alerta enviada a caja de alertas");
  } else {
    Serial.printf("Error al enviar alerta: %d\n", code);
  }
  http.end();
}

String urlencode(String str) {
  String encodedString = "";
  char c;
  char code0;
  char code1;

  for (unsigned int i = 0; i < str.length(); i++) {
    c = str.charAt(i);
    if (c == ' ') {
      encodedString += '+';
    } else if (isalnum(c)) {
      encodedString += c;
    } else {
      code1 = (c & 0xf) + '0';
      if ((c & 0xf) > 9) {
        code1 = (c & 0xf) - 10 + 'A';
      }
      c = (c >> 4) & 0xf;
      code0 = c + '0';
      if (c > 9) {
        code0 = c - 10 + 'A';
      }
      encodedString += '%';
      encodedString += code0;
      encodedString += code1;
    }
  }
  return encodedString;
}
